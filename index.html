<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Railway Tracker</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #ccc;
            margin: 0;
            padding: 20px;
        }
        h1 { font-size: 1.2rem; color: #fff; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .service {
            padding: 15px 0;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .service:last-child { border-bottom: none; }
        .meta { display: flex; flex-direction: column; }
        .name { color: #fff; font-weight: bold; }
        .project { color: #666; font-size: 0.8rem; }
        .status { font-weight: bold; padding: 2px 8px; border-radius: 3px; }
        .status.SUCCESS { color: #00ff00; }
        .status.BUILDING { color: #ffff00; }
        .status.CRASHED, .status.FAILED { color: #ff4444; }
        .status.INITIALIZING { color: #00aaff; }
        .time { color: #444; font-size: 0.7rem; margin-top: 4px; }
        #controls { margin-top: 20px; font-size: 0.8rem; color: #555; }
        button { background: #222; color: #888; border: 1px solid #444; padding: 5px 10px; cursor: pointer; }
        button:hover { background: #333; color: #fff; }
    </style>
</head>
<body>
    <h1>RAILWAY DEPLOYMENT TRACKER</h1>
    <div id="list">Loading services...</div>
    
    <div id="controls">
        <button onclick="unlockAudio()">Enable Audio</button>
        <span id="audio-status">Audio is locked (click enable)</span>
    </div>

    <script>
        let audioCtx;
        function unlockAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('audio-status').innerText = 'Audio Active';
            }
        }

        function playSound(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'SUCCESS') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); // A5
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'BUILDING') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'FAILED' || type === 'CRASHED') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(110, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(55, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            }
        }

        const list = document.getElementById('list');
        const services = {};

        function render() {
            list.innerHTML = Object.values(services)
                .sort((a, b) => new Date(b.at) - new Date(a.at))
                .map(s => `
                    <div class="service">
                        <div class="meta">
                            <span class="name">${s.serviceName}</span>
                            <span class="project">${s.projectName}</span>
                            <span class="time">${new Date(s.at).toLocaleString()}</span>
                        </div>
                        <span class="status ${s.status}">${s.status}</span>
                    </div>
                `).join('') || 'No services found.';
        }

        const evtSource = new EventSource("/events");
        evtSource.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'init') {
                Object.assign(services, msg.data);
                render();
            } else if (msg.type === 'update') {
                const oldStatus = services[msg.serviceId]?.status;
                services[msg.serviceId] = {
                    projectName: msg.projectName,
                    serviceName: msg.serviceName,
                    status: msg.status,
                    at: msg.at
                };
                render();
                
                if (oldStatus !== msg.status) {
                    playSound(msg.status);
                }
            }
        };
    </script>
</body>
</html>
